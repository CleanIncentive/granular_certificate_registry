services:
  gc_registry:
    image: gc_registry:latest
    restart: "${RESTART-no}"
    environment:
      - TC_HOST=host.docker.internal
    volumes:
      - ./:/app
      - /var/run/docker.sock:/var/run/docker.sock
      - "./:/gc_registry"
    build:
      context: .
      args:
        INSTALL_DEV: ${INSTALL_DEV-true}
    command: poetry run uvicorn --reload "gc_registry.main:app" --host 0.0.0.0 --port 4200 --log-level debug
    env_file:
      - .env
    depends_on:
      - db_write
      - db_read
    ports:
      - "4200:4200"

  db_write:
    image: postgres:13
    volumes:
      - postgres_data_write:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=db_write
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password

  db_read:
    image: postgres:13
    volumes:
      - postgres_data_read:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=db_read
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password

  eventstore.db:
    image: eventstore/eventstore:release-v5
    environment:
      - EVENTSTORE_CLUSTER_SIZE=1
      - EVENTSTORE_RUN_PROJECTIONS=All
      - EVENTSTORE_START_STANDARD_PROJECTIONS=True
      - EVENTSTORE_DB=/var/lib/eventstore-data
      - EVENTSTORE_INDEX=/var/lib/eventstore-index
      - EVENTSTORE_LOG=/var/log/eventstore
      - EVENTSTORE_EXT_TCP_PORT=1113
      - EVENTSTORE_EXT_HTTP_PORT=2113
    ports:
      - "1113:1113"
      - "2113:2113"
    volumes:
      - type: volume
        source: eventstore-volume-data
        target: /var/lib/eventstore-data
      - type: volume
        source: eventstore-volume-index
        target: /var/lib/eventstore-index
      - type: volume
        source: eventstore-volume-logs
        target: /var/log/eventstore

volumes:
  gc_registry:
  postgres_data_write:
  postgres_data_read:
  eventstore-volume-data: